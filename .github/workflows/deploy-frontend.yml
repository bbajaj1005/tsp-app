name: Deploy Frontend

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}      
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Connect to AKS
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_NAME }} \
            --overwrite-existing
      
      - name: Get Backend Service URL
        id: get-backend-url
        run: |
          # Get the backend service IP
          BACKEND_IP=$(kubectl get svc backend-api-service -n tsp-app -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          
          if [ -z "$BACKEND_IP" ]; then
            # If no external IP, try to get the service cluster IP or use the service DNS name
            BACKEND_IP=$(kubectl get svc backend-api-service -n tsp-app -o jsonpath='{.spec.clusterIP}' 2>/dev/null || echo "")
            if [ -n "$BACKEND_IP" ]; then
              BACKEND_URL="http://${BACKEND_IP}:80"
            else
              # Use service DNS name as fallback
              BACKEND_URL="http://backend-api-service.tsp-app.svc.cluster.local:80"
            fi
          else
            BACKEND_URL="http://${BACKEND_IP}:80"
          fi
          
          echo "Backend URL: $BACKEND_URL"
          echo "REACT_APP_API_URL=$BACKEND_URL" >> $GITHUB_ENV
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          
      - name: Build
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: ${{ env.REACT_APP_API_URL || 'http://localhost:3001' }}
        run: |
          echo "Building with API URL: $REACT_APP_API_URL"
          npm install
          npm run build
          
      - name: Prepare Deployment Package
        run: |
          # Copy server.js and package.json to build directory
          cp ./frontend/server.js ./frontend/build/
          cp ./frontend/package.json ./frontend/build/
          
          # Create a minimal package.json for production (only express)
          cat > ./frontend/build/package.json << EOF
          {
            "name": "tsp-frontend",
            "version": "1.0.0",
            "main": "server.js",
            "scripts": {
              "start": "node server.js"
            },
            "dependencies": {
              "express": "^4.18.2"
            }
          }
          EOF
          
          echo "ðŸ“¦ Deployment package contents:"
          ls -la ./frontend/build/ | head -20
          echo ""
          echo "ðŸ“„ Checking for required files:"
          ls -la ./frontend/build/index.html && echo "âœ“ index.html found"
          ls -la ./frontend/build/server.js && echo "âœ“ server.js found"
          ls -la ./frontend/build/package.json && echo "âœ“ package.json found"
          
      - name: Configure Web App for Node.js
        run: |
          # Ensure Node.js version is set
          az webapp config appsettings set \
            --name ${{ secrets.WEBAPP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --settings WEBSITE_NODE_DEFAULT_VERSION="18-lts" SCM_DO_BUILD_DURING_DEPLOYMENT="true" || true
          
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./frontend/build